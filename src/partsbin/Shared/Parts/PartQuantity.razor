@using partsbin.Services
@using System.Text
@using partsbin.BusinessLogic.Models
@using partsbin.BusinessLogic.Services
@inject IPartUiService PartUiService;
@inject IToastService ToastService;
@inject IPartService PartService;

<span class="keep-together">
    <button class="btn btn-light btn-sm"
           @onclick="DecreaseQuantity"
           @onclick:preventDefault
           title="Decrease quantity">
        <i class="oi oi-minus"></i>
    </button>
    <button class="btn btn-sm @GetButtonClass()"
            style="min-width:4em;"
            @onclick="EditQuantity"
            @onclick:preventDefault
            title="Edit quantity">
        @Part.Quantity
    </button>
    <button class="btn btn-light"
            @onclick="IncreaseQuantity"
            @onclick:preventDefault
            title="Increase quantity">
        <i class="oi oi-plus"></i>
    </button>
    <em style="font-size:small;margin-top:10px">
        @(Part.QuantityIsApproximate ? "Quantity is approximate" : "Quantity is exact")
        <a href="#" style="" role="button"
           @onclick="ToggleQuantityIsApproximate"
           @onclick:preventDefault>
            Toggle
        </a>
    </em>
    
</span>
                                
@code {
    [Parameter]
    public required Part Part { get; set; }
    [Parameter]
    public EventCallback<Part> PartChanged { get; set; }

    [Parameter]
    public bool Outline { get; set; } = false;
    
    private string GetButtonClass()
    {
        var sb = new StringBuilder();
        
        sb.Append("btn");
        
        if (Outline)
        {
            sb.Append("-outline");
        }

        sb.Append(Part.Quantity > 0 ? "-primary" : "-danger");
        
        return sb.ToString();
    }

    private async void EditQuantity()
    {
        var previousQuantity = Part.Quantity;
        
        await PartUiService.EditQuantity(Part);

        if (previousQuantity == Part.Quantity) return;
        
        if (Part.Quantity < 0)
        {
            ToastService.ShowWarning("The part quantity has been set to less than zero. It has still been saved.");
        }
        else
        {
            ToastService.ShowSuccess("The part quantity has been updated");
        }
        
        StateHasChanged();
        await PartChanged.InvokeAsync(Part);
    }

    private async void IncreaseQuantity()
    {
        Part.Quantity++;
        await PartService.UpdatePart(Part);
        StateHasChanged();
        await PartChanged.InvokeAsync(Part);
    }
    
    private async void DecreaseQuantity()
    {
        Part.Quantity--;
        await PartService.UpdatePart(Part);
        StateHasChanged();
        await PartChanged.InvokeAsync(Part);
    }

    private async void ToggleQuantityIsApproximate()
    {
        Part.QuantityIsApproximate = !Part.QuantityIsApproximate;
        await PartService.UpdatePart(Part);
        StateHasChanged();
    }
}